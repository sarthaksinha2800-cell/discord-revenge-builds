name: ðŸš€ Discord Revenge Bundle Builder

on:
  schedule:
    - cron: "0 9 * * *"  # Daily at 9 AM UTC
  workflow_dispatch:      # Manual trigger
    inputs:
      force_build:
        description: 'Force build even if no new version'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main, master ]

permissions:
  contents: write

env:
  REVENGE_REPO: "revenge-mod/revenge-bundle"

jobs:
  build:
    name: ðŸ› ï¸ Build Revenge Bundle
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ”§ Setup Bun runtime
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: 'latest'
        
    - name: ðŸ” Check for Revenge updates
      id: check-updates
      run: |
        echo "Checking for updates from $REVENGE_REPO..."
        
        # Get latest release info
        LATEST_RELEASE_JSON=$(curl -s "https://api.github.com/repos/$REVENGE_REPO/releases/latest")
        LATEST_VERSION=$(echo "$LATEST_RELEASE_JSON" | jq -r '.tag_name // .name')
        
        if [ "$LATEST_VERSION" = "null" ]; then
          echo "âŒ Could not get latest version"
          exit 1
        fi
        
        echo "Latest version: $LATEST_VERSION"
        
        # Check if we need to build
        SHOULD_BUILD="false"
        if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
          echo "ðŸš€ Force build requested"
          SHOULD_BUILD="true"
        elif [ ! -f "last_successful_version.txt" ]; then
          echo "ðŸ†• First build"
          SHOULD_BUILD="true"
        elif [ "$LATEST_VERSION" != "$(cat last_successful_version.txt)" ]; then
          echo "ðŸ†• New version detected: $LATEST_VERSION (was: $(cat last_successful_version.txt))"
          SHOULD_BUILD="true"
        else
          echo "âœ… Already on latest version: $LATEST_VERSION"
        fi
        
        echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        
    - name: ðŸ“¥ Clone Revenge source
      if: steps.check-updates.outputs.should_build == 'true'
      run: |
        echo "Cloning Revenge source code..."
        git clone https://github.com/$REVENGE_REPO.git revenge-source
        cd revenge-source
        
        # Checkout specific version if needed
        if [ "${{ steps.check-updates.outputs.latest_version }}" != "latest" ]; then
          git checkout ${{ steps.check-updates.outputs.latest_version }} 2>/dev/null || echo "Using latest commit"
        fi
        
        echo "âœ… Revenge source cloned"
        
    - name: ðŸ“¦ Install dependencies
      if: steps.check-updates.outputs.should_build == 'true'
      run: |
        echo "Installing dependencies with Bun..."
        cd revenge-source
        bun install
        echo "âœ… Dependencies installed"
        
    - name: ðŸ› ï¸ Build Revenge bundle
      if: steps.check-updates.outputs.should_build == 'true'
      id: build-bundle
      run: |
        echo "Building Revenge bundle..."
        cd revenge-source
        
        # Build the bundle
        bun run build
        
        # Verify build output
        if [ -f "dist/revenge.js" ]; then
          BUNDLE_SIZE=$(stat -c%s "dist/revenge.js")
          echo "âœ… Bundle built successfully: $BUNDLE_SIZE bytes"
          echo "bundle_size=$BUNDLE_SIZE" >> $GITHUB_OUTPUT
        else
          echo "âŒ Bundle build failed - no output file"
          exit 1
        fi
        
        echo "ðŸ“¦ Bundle ready for release"
        
    - name: ðŸ—‚ï¸ Prepare release files
      if: steps.check-updates.outputs.should_build == 'true'
      run: |
        echo "Preparing release files..."
        
        # Copy bundle to root directory
        cp revenge-source/dist/revenge.js revenge.js
        
        # Create build info
        cat > build-info.json << EOF
        {
          "version": "${{ steps.check-updates.outputs.latest_version }}",
          "build_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "build_id": "${{ github.run_id }}-${{ github.run_attempt }}",
          "bundle_size": ${{ steps.build-bundle.outputs.bundle_size }},
          "source": "https://github.com/$REVENGE_REPO",
          "build_log": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
          "direct_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/revenge.js"
        }
        EOF
        
        echo "ðŸ“‹ Release files prepared"
        ls -la revenge.js build-info.json
        
    - name: ðŸ“¤ Commit and push bundle
      if: steps.check-updates.outputs.should_build == 'true'
      run: |
        echo "Committing and pushing bundle to repository..."
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add and commit the built files
        git add revenge.js build-info.json
        git commit -m "ðŸ“¦ Build Revenge ${{ steps.check-updates.outputs.latest_version }} [skip ci]" || exit 0
        
        # Push changes
        git push origin main
        
        echo "âœ… Bundle committed to repository"
        
    - name: ðŸ·ï¸ Create simple release
      if: steps.check-updates.outputs.should_build == 'true'
      run: |
        echo "Creating GitHub release..."
        
        # Create release using GitHub CLI
        gh release create \
          "v${{ steps.check-updates.outputs.latest_version }}" \
          revenge.js \
          build-info.json \
          --title "Revenge Bundle ${{ steps.check-updates.outputs.latest_version }}" \
          --notes "Automated build of Revenge bundle ${{ steps.check-updates.outputs.latest_version }}
          
          **Direct URL:** https://raw.githubusercontent.com/${{ github.repository }}/main/revenge.js
          
          Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Size: ${{ steps.build-bundle.outputs.bundle_size }} bytes
          
          Use this URL in Discord: https://raw.githubusercontent.com/${{ github.repository }}/main/revenge.js"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ’¾ Update version tracking
      if: steps.check-updates.outputs.should_build == 'true' && success()
      run: |
        echo "${{ steps.check-updates.outputs.latest_version }}" > last_successful_version.txt
        git add last_successful_version.txt
        git commit -m "ðŸ“Œ Update to Revenge ${{ steps.check-updates.outputs.latest_version }} [skip ci]" || exit 0
        git push
        
    - name: ðŸ“¤ Upload build artifacts
      if: steps.check-updates.outputs.should_build == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: revenge-bundle-${{ steps.check-updates.outputs.latest_version }}
        path: |
          revenge.js
          build-info.json
        retention-days: 30
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        rm -rf revenge-source/
        echo "Cleanup complete"
